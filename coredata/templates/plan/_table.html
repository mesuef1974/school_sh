{% load static %}
<div class="site-main" style="padding: 0; margin-top: 1rem; border: none; box-shadow: none; background: transparent;">

    <!-- Pagination and Controls -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="per-page-group">
                <label for="per_page_select">عرض:</label>
                <select name="per_page" id="per_page_select" class="filter-select-styled"
                        hx-get="{% url 'plan_list' %}"
                        hx-target="#plan-table-container"
                        hx-include="#filters-form"
                        hx-push-url="true">
                    <option value="25" {% if per_page == "25" %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == "50" %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == "100" %}selected{% endif %}>100</option>
                    <option value="all" {% if per_page == "all" %}selected{% endif %}>الكل</option>
                </select>
            </div>
            <span class="results-count">
                {% if per_page == "all" %}
                    عرض <strong>{{ page_obj.count }}</strong> سجل
                {% else %}
                    <strong>{{ page_obj.start_index }}-{{ page_obj.end_index }}</strong> من <strong>{{ page_obj.paginator.count }}</strong>
                {% endif %}
            </span>
        </div>

        <div class="pagination-controls">
            {% if per_page != "all" %}
                {% if page_obj.has_previous %}
                    <a href="?page=1&{{ pagination_url_params }}" hx-get="?page=1&{{ pagination_url_params }}" hx-target="#plan-table-container" hx-push-url="true" class="pagination-btn-modern" title="الأولى">
                        <i class="fa-solid fa-angles-right"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}&{{ pagination_url_params }}" hx-get="?page={{ page_obj.previous_page_number }}&{{ pagination_url_params }}" hx-target="#plan-table-container" hx-push-url="true" class="pagination-btn-modern" title="السابقة">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                {% endif %}

                <span class="pagination-number-active">{{ page_obj.number }}</span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&{{ pagination_url_params }}" hx-get="?page={{ page_obj.next_page_number }}&{{ pagination_url_params }}" hx-target="#plan-table-container" hx-push-url="true" class="pagination-btn-modern" title="التالية">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}&{{ pagination_url_params }}" hx-get="?page={{ page_obj.paginator.num_pages }}&{{ pagination_url_params }}" hx-target="#plan-table-container" hx-push-url="true" class="pagination-btn-modern" title="الأخيرة">
                        <i class="fa-solid fa-angles-left"></i>
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="smart-table">
            <thead class="branded-header">
                <tr>
                    <th style="width: 40px;"></th> <!-- Actions -->

                    {% if view_role == 'executor' %}
                        <th style="width: 10%;">المجال</th>
                        <th style="width: 50px;"># الهدف</th>
                        <th style="width: 15%;">الهدف</th>
                        <th style="width: 50px;"># مؤشر</th>
                        <th style="width: 50px;"># اجراء</th>
                        <th style="width: 15%;">الاجراء</th>
                        <th style="width: 80px;">زمن التنفيذ</th>
                        <th style="width: 90px;">المتابعة</th>
                        <th style="width: 90px;">طلب دليل</th>
                        <th style="width: 10%;">موقع الدليل</th>
                        <th style="width: 10%;">ملاحظات التنفيذ</th>
                        <th style="width: 90px;">قرار اللجنة</th>
                        <th style="width: 15%;">ملاحظات المراجعة</th>
                    {% else %} {# This is the 'evaluator' view for 'لجنة المراجعة الذاتية' #}
                        <th style="width: 10%;">المنفذ</th>
                        <th style="width: 40px;"># اجراء</th>
                        <th style="width: 15%;">الاجراء</th>
                        <th style="width: 40px;"># مؤشر</th>
                        <th style="width: 15%;">المؤشر</th>
                        <th style="width: 12%;">ملاحظات التنفيذ</th>
                        <th style="width: 10%;">موقع الدليل</th>
                        <th style="width: 80px;">طلب الدليل</th>
                        <th style="width: 12%;">ملاحظات المراجعة</th>
                        <th style="width: 90px;">قرار اللجنة</th>
                        <th style="width: 80px;">التقييم النهائي</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in page_obj %}
                    {% include "plan/_row.html" with it=item view_role=view_role %}
                {% empty %}
                <tr>
                    <td colspan="{% if view_role == 'executor' %}13{% else %}11{% endif %}" style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <span>لا توجد نتائج تطابق بحثك.</span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .pagination-container {
        width: 99%;
        margin: 0 auto 1rem auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        border: 1px solid rgba(128, 0, 0, 0.2);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .pagination-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .per-page-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .per-page-group label {
        font-weight: 700;
        font-size: 0.85rem;
        color: var(--brand-maroon);
        font-family: 'Tajawal', sans-serif;
    }

    .filter-select-styled {
        padding: 5px 12px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        background-color: #fff;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
        outline: none;
    }

    .filter-select-styled:focus {
        border-color: var(--maroon);
        box-shadow: 0 0 0 3px rgba(128, 0, 0, 0.1);
    }

    .results-count {
        color: #6b7280;
        font-size: 0.85rem;
        border-right: 2px solid #f3f4f6;
        padding-right: 1.5rem;
        font-family: 'Tajawal', sans-serif;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .pagination-btn-modern {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: #fff;
        border: 1.5px solid #e5e7eb;
        color: #4b5563;
        text-decoration: none;
        font-size: 0.8rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pagination-btn-modern:hover {
        background: var(--maroon);
        color: #fff;
        border-color: var(--maroon);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(128, 0, 0, 0.2);
    }

    .pagination-number-active {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--maroon) 0%, #5b0e2d 100%);
        color: #fff;
        font-weight: 800;
        font-size: 0.9rem;
        box-shadow: 0 4px 10px rgba(128, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-responsive {
        width: 99%;
        margin: 0 auto;
        border-radius: 12px;
        border: 1px solid var(--maroon);
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    }

    .smart-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        table-layout: fixed;
    }

    .smart-table th {
        padding: 8px 5px;
        text-align: center !important;
        vertical-align: middle !important;
        font-weight: 700;
        font-size: 0.75rem;
        line-height: 1.3;
        border: 1px solid var(--maroon);
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
    }

    .smart-table td {
        padding: 10px 8px;
        border: 1px solid var(--maroon);
        vertical-align: middle !important;
        text-align: center !important;
        font-size: 0.9rem;
        color: #1f2937;
        word-wrap: break-word;
        overflow-wrap: break-word;
        background-color: inherit;
        font-family: 'Amiri', serif !important;
    }

    .smart-table tbody tr:nth-of-type(even) {
        background-color: #f0fff4 !important;
    }

    .smart-table tbody tr:nth-of-type(odd) {
        background-color: #ffffff !important;
    }
</style>
<script>
    // Ensure the select option is correctly set on load
    document.addEventListener('DOMContentLoaded', function() {
        var select = document.getElementById('per_page_select');
        if (select) {
            var selectedValue = "{{ per_page }}";
            for (var i = 0; i < select.options.length; i++) {
                if (select.options[i].value === selectedValue) {
                    select.options[i].selected = true;
                    break;
                }
            }
        }
    });
</script>